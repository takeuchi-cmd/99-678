<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ã–ã›ï¼ä¹ä¹ãƒã‚¹ã‚¿ãƒ¼ 6ãƒ»7ãƒ»8ã®æ®µãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* æ˜ã‚‹ã„èƒŒæ™¯ */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« (åˆæœŸè¡¨ç¤ºã¯hidden) -->
    <div id="username-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm space-y-4">
            <h2 class="text-2xl font-bold text-indigo-700 text-center">ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ãƒ ã‚’ç™»éŒ²</h2>
            <p class="text-gray-600 text-sm text-center">è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ã€åå‰ã‚’æ•™ãˆã¦ã­ï¼</p>
            <input 
                type="text" 
                id="username-input" 
                class="w-full p-3 border-2 border-indigo-300 rounded-lg text-lg focus:ring-indigo-500 focus:border-indigo-500" 
                placeholder="ä¾‹: ãŸã‚ã†"
                maxlength="10"
                onkeypress="if(event.key === 'Enter') saveUserName();"
            >
            <button 
                id="save-username-button" 
                class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-200"
                onclick="saveUserName()"
            >
                ç™»éŒ²ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="w-full max-w-lg bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100 transition duration-500">
        
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="text-right text-sm text-gray-500 mb-2">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="username-display" class="font-semibold text-indigo-500">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        
        <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6">ã‚ã–ã›ï¼ä¹ä¹ãƒã‚¹ã‚¿ãƒ¼ 6ãƒ»7ãƒ»8ã®æ®µãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
        <p class="text-center text-gray-500 mb-8">å…¨5å•ã§ã™ã€‚ãŒã‚“ã°ã£ã¦ã­ï¼</p>

        <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ -->
        <div id="game-area" class="space-y-6">
            
            <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="question-display" class="hidden text-center">
                <p id="question-number" class="text-sm font-semibold text-gray-400 mb-2"></p>
                <div class="flex items-center justify-center space-x-4 bg-indigo-50 p-6 rounded-xl shadow-inner">
                    <span id="multiplier1" class="text-5xl font-bold text-indigo-900">?</span>
                    <span class="text-4xl text-indigo-600">Ã—</span>
                    <span id="multiplier2" class="text-5xl font-bold text-indigo-900">?</span>
                    <span class="text-4xl text-indigo-600">=</span>
                    <span class="text-4xl text-gray-400">?</span>
                </div>
            </div>

            <!-- å›ç­”å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="answer-area" class="hidden space-y-4">
                <input 
                    type="number" 
                    id="answer-input" 
                    class="w-full text-center text-3xl p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" 
                    placeholder="ç­”ãˆã‚’å…¥åŠ›"
                    min="1"
                    max="81"
                    onkeypress="if(event.key === 'Enter') checkAnswer();"
                >
                <button 
                    id="submit-button" 
                    class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-200"
                    onclick="checkAnswer()"
                >
                    å›ç­”ã™ã‚‹
                </button>
            </div>

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (å›ç­”ã‚¨ãƒªã‚¢ã‹ã‚‰åˆ†é›¢ã—ã€å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´) -->
            <div id="feedback" class="h-8 text-center text-lg font-semibold transition duration-300"></div>

            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ/çµæœã‚¨ãƒªã‚¢ -->
            <div id="start-area" class="text-center">
                <button 
                    id="start-button" 
                    class="w-full py-4 bg-green-500 text-white text-xl font-extrabold rounded-xl shadow-lg hover:bg-green-600 transition duration-200"
                    onclick="startGame()"
                    disabled
                >
                    ç·´ç¿’é–‹å§‹ï¼
                </button>
            </div>
            
        </div>

        <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
        <div id="score-status" class="mt-8 pt-4 border-t border-gray-200 text-sm flex justify-between">
            <p id="current-score" class="font-semibold text-gray-700">æ­£è§£æ•°: 0 / 0</p>
            <p id="current-question" class="font-semibold text-gray-700">æ®‹ã‚Š: 0 å•</p>
        </div>
        
        <!-- æ™‚é–“è¨ˆæ¸¬ã¨æœ€é«˜è¨˜éŒ²ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¿½åŠ  -->
        <div id="record-display" class="mt-4 pt-4 border-t border-gray-200 text-sm space-y-2">
            <!-- å€‹äººã®ä»Šå›ã®è¨˜éŒ² -->
            <p id="time-taken" class="font-bold text-gray-800">ä»Šå›ã®å›ç­”æ™‚é–“: --</p>
            
            <!-- å€‹äººã®æœ€é«˜è¨˜éŒ²ã¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ç¾¤ -->
            <p id="personal-best-container" class="font-bold text-green-600 flex justify-between items-center">
                <span id="best-record-personal">å€‹äººã®æœ€é«˜è¨˜éŒ² (5å•): </span>
                <span class="space-x-2 flex">
                    <!-- è¨˜éŒ²ã®ã¿ãƒªã‚»ãƒƒãƒˆ -->
                    <button 
                        onclick="showResetPrompt('record')" 
                        class="text-xs text-red-500 hover:text-red-700 font-normal py-1 px-2 rounded-lg border border-red-300 bg-red-50 transition duration-150 whitespace-nowrap"
                    >
                        è¨˜éŒ²ã®ã¿ãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <!-- ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ -->
                    <button 
                        onclick="showResetPrompt('all')" 
                        class="text-xs text-red-700 hover:text-red-900 font-bold py-1 px-2 rounded-lg border border-red-500 bg-red-200 transition duration-150 whitespace-nowrap"
                    >
                        ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ (åå‰ã‚‚)
                    </button>
                </span>
            </p>

            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢ (æœ€åˆã¯éè¡¨ç¤º) -->
            <div id="reset-password-area" class="hidden mt-4 p-3 bg-red-50 border border-red-300 rounded-lg space-y-2">
                <p id="reset-prompt-title" class="text-red-700 font-semibold text-center">è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input 
                    type="password" 
                    id="password-input" 
                    class="w-full p-2 border border-red-300 rounded text-base text-gray-800 focus:ring-red-500 focus:border-red-500" 
                    placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                    onkeypress="if(event.key === 'Enter') confirmReset();"
                >
                <div class="flex justify-end space-x-2">
                    <button 
                        onclick="hideResetPrompt()" 
                        class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                    >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button 
                        onclick="confirmReset()" 
                        id="reset-execute-button"
                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
                    >
                        ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
                    </button>
                    <input type="hidden" id="reset-mode" value="">
                </div>
            </div>

            <!-- å…¨ä½“ã®æœ€é«˜è¨˜éŒ²ãƒªã‚¹ãƒˆã‚’è¿½åŠ  -->
            <div class="pt-4 border-t border-gray-200">
                <h3 class="text-lg font-bold text-indigo-700 mb-2">ğŸ† å…¨ä½“ã®æœ€é«˜è¨˜éŒ² (ãƒˆãƒƒãƒ—5)</h3>
                <ul id="global-records-list" class="space-y-1">
                    <li class="text-gray-500">è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
                </ul>
            </div>
        </div>

    </div>

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ (module type) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
        setLogLevel('Debug');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã« window ã«ã‚¢ã‚¿ãƒƒãƒ
        window.DANS = [6, 7, 8];
        window.MAX_QUESTIONS = 5;
        window.NEXT_QUESTION_DELAY = 800;
        window.RESET_PASSWORD = 'shinai';

        window.questions = [];
        window.currentQuestionIndex = 0;
        window.score = 0;
        window.startTime = 0;
        window.timeTaken = 0;
        window.bestTime = Infinity;

        // Firebase / Context Variables
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.userName = null;
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestoreãƒ‘ã‚¹ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const getUserProfileRef = (uid) => doc(window.db, `artifacts/${APP_ID}/users/${uid}/settings`, 'profile');
        // å€‹äººæœ€é«˜è¨˜éŒ² (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)
        const getPersonalBestTimeRef = (uid) => doc(window.db, `artifacts/${APP_ID}/users/${uid}/kuku_records`, 'best_time');
        // å…¬é–‹è¨˜éŒ² (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã™ã‚‹)
        const getGlobalRecordRef = (uid) => doc(window.db, `artifacts/${APP_ID}/public/data/kuku_global_records`, uid);
        const getGlobalRecordsCollection = () => collection(window.db, `artifacts/${APP_ID}/public/data/kuku_global_records`);

        // DOMè¦ç´ 
        const usernameModalEl = document.getElementById('username-modal');
        const usernameInputEl = document.getElementById('username-input');
        const usernameDisplayEl = document.getElementById('username-display');
        const startButtonEl = document.getElementById('start-button');
        const feedbackEl = document.getElementById('feedback');
        const personalBestEl = document.getElementById('best-record-personal');
        const globalRecordsListEl = document.getElementById('global-records-list');
        const passwordInputEl = document.getElementById('password-input');
        const resetPasswordAreaEl = document.getElementById('reset-password-area');
        const resetPromptTitleEl = document.getElementById('reset-prompt-title');
        const resetModeInputEl = document.getElementById('reset-mode');


        // --- Firebase/Auth/Firestore Logic ---

        async function loadUserProfile() {
            if (!window.db || !window.userId) return;

            const profileSnap = await getDoc(getUserProfileRef(window.userId));
            if (profileSnap.exists()) {
                window.userName = profileSnap.data().name;
                usernameDisplayEl.textContent = window.userName;
                usernameModalEl.classList.add('hidden');
                startButtonEl.disabled = false; // åå‰ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯èƒ½
                await loadBestRecord(); // åå‰ãŒç¢ºå®šã—ãŸã‚‰è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰
            } else {
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã„å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
                window.userName = null;
                usernameDisplayEl.textContent = 'æœªç™»éŒ²';
                usernameModalEl.classList.remove('hidden');
            }
        }

        async function loadBestRecord() {
            if (!window.db || !window.userId) return;

            // 1. å€‹äººã®æœ€é«˜è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)
            try {
                const docRef = getPersonalBestTimeRef(window.userId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    window.bestTime = docSnap.data().time || Infinity;
                } else {
                    window.bestTime = Infinity;
                }
                
                // è¡¨ç¤ºã‚’æ›´æ–° (å€‹äººã®è¨˜éŒ²ã«ã¯è‡ªåˆ†ã®åå‰ã‚’è¡¨ç¤º)
                const nameDisplay = window.userName ? ` (${window.userName})` : '';
                personalBestEl.textContent = `å€‹äººã®æœ€é«˜è¨˜éŒ² (5å•): ${formatTime(window.bestTime)}${nameDisplay}`;
            } catch (error) {
                console.error("Error loading personal best record:", error);
                window.bestTime = Infinity;
                personalBestEl.textContent = `å€‹äººã®æœ€é«˜è¨˜éŒ² (5å•): -- (èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼)`;
            }

            // 2. å…¨ä½“ã®æœ€é«˜è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰ (ãƒ‘ãƒ–ãƒªãƒƒã‚¯)
            await loadGlobalRecords();
        }

        async function loadGlobalRecords() {
            if (!window.db) return;
            globalRecordsListEl.innerHTML = '<li class="text-gray-500">è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>';

            try {
                // NOTE: Firestoreã®orderByã¯åˆ©ç”¨ã›ãšã€JavaScriptã§ã‚½ãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
                const q = query(getGlobalRecordsCollection());
                
                const querySnapshot = await getDocs(q);
                let records = [];

                if (querySnapshot.empty) {
                    globalRecordsListEl.innerHTML = '<li class="text-gray-500">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€ç•ªã‚’ç›®æŒ‡ãã†ï¼</li>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.time && data.time !== Infinity) {
                        records.push({
                            id: doc.id,
                            time: data.time,
                            userName: data.userName || 'åŒ¿å'
                        });
                    }
                });
                
                // JavaScriptã§æ™‚é–“ (time) ã®æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã—ã€ãƒˆãƒƒãƒ—5ã«é™å®š
                records.sort((a, b) => a.time - b.time);
                const topRecords = records.slice(0, 5);

                globalRecordsListEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                
                topRecords.forEach((record, index) => {
                    const rank = index + 1;
                    const time = formatTime(record.time);
                    const name = record.userName;
                    const isCurrentUser = record.id === window.userId;

                    const listItem = document.createElement('li');
                    listItem.className = `p-1 rounded flex justify-between items-center ${isCurrentUser ? 'bg-yellow-100 font-semibold' : 'text-gray-700'}`;
                    
                    // åå‰ã¨æ™‚é–“ã‚’åˆ†ã‘ã¦è¡¨ç¤ºã—ã€åå‰ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ç¢ºä¿
                    listItem.innerHTML = `
                        <span class="text-lg w-5 mr-2">${rank}.</span>
                        <span class="flex-grow truncate text-sm text-gray-900">${name}</span>
                        <span class="${isCurrentUser ? 'text-indigo-600' : 'text-gray-900'} font-extrabold ml-2">${time}</span>
                    `;
                    globalRecordsListEl.appendChild(listItem);
                });

            } catch (error) {
                console.error("Error loading global records:", error);
                globalRecordsListEl.innerHTML = '<li class="text-red-500">å…¨ä½“è¨˜éŒ²ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</li>';
            }
        }
        
        window.saveUserName = async function() {
            const name = usernameInputEl.value.trim();
            if (name.length < 1) {
                feedbackEl.textContent = 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                feedbackEl.classList.add('text-red-600');
                return;
            }

            if (!window.db || !window.userId) {
                console.error("Database not initialized.");
                return;
            }

            try {
                await setDoc(getUserProfileRef(window.userId), { name: name });
                window.userName = name;
                usernameDisplayEl.textContent = name;
                usernameModalEl.classList.add('hidden');
                startButtonEl.disabled = false;
                feedbackEl.textContent = `${name}ã•ã‚“ã€ã‚ˆã†ã“ãï¼æº–å‚™ãŒã§ããŸã‚‰ç·´ç¿’é–‹å§‹ï¼`;
                feedbackEl.classList.remove('text-red-600');
                feedbackEl.classList.add('text-indigo-500');
                await loadBestRecord(); // å€‹äººè¨˜éŒ²ã¨å…¨ä½“è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰
            } catch (error) {
                console.error("Error saving username:", error);
                feedbackEl.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                feedbackEl.classList.add('text-red-600');
            }
        }

        /**
         * è¨˜éŒ²ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ (åå‰ã¯æ®‹ã™)
         */
        async function resetRecordOnly() {
            if (!window.db || !window.userId) return;
            
            try {
                // 1. å€‹äººã®è¨˜éŒ²ã‚’å‰Šé™¤ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)
                await deleteDoc(getPersonalBestTimeRef(window.userId));
                // 2. å…¬é–‹è¨˜éŒ²ã‚’å‰Šé™¤ (ãƒ‘ãƒ–ãƒªãƒƒã‚¯)
                await deleteDoc(getGlobalRecordRef(window.userId));
                
                window.bestTime = Infinity;
                await loadBestRecord(); // è¡¨ç¤ºã‚’æ›´æ–° (loadBestRecordå†…ã§loadGlobalRecordsã‚‚å‘¼ã³å‡ºã•ã‚Œã‚‹)

                feedbackEl.textContent = 'è¨˜éŒ²ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã¾ãŸé ‘å¼µã‚ã†ï¼';
                feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600', 'text-indigo-500');
                feedbackEl.classList.add('text-red-500');
            } catch (error) {
                console.error("Error resetting record:", error);
                feedbackEl.textContent = 'ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                feedbackEl.classList.add('text-red-600');
            }
            hideResetPrompt();
        }

        /**
         * åå‰ã¨è¨˜éŒ²ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
         */
        async function resetNameAndRecord() {
            if (!window.db || !window.userId) return;
            
            try {
                // 1. å€‹äººã®è¨˜éŒ²ã‚’å‰Šé™¤ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)
                await deleteDoc(getPersonalBestTimeRef(window.userId));
                // 2. å…¬é–‹è¨˜éŒ²ã‚’å‰Šé™¤ (ãƒ‘ãƒ–ãƒªãƒƒã‚¯)
                await deleteDoc(getGlobalRecordRef(window.userId));
                // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å‰Šé™¤ (åå‰ã‚‚ãƒªã‚»ãƒƒãƒˆ)
                await deleteDoc(getUserProfileRef(window.userId));
                
                window.bestTime = Infinity;
                window.userName = null;

                // è¨˜éŒ²ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ¶ˆå»ã•ã‚ŒãŸãŸã‚ã€å¼·åˆ¶çš„ã«å†ãƒ­ãƒ¼ãƒ‰ã—ã¦åå‰ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
                hideResetPrompt();
                startButtonEl.disabled = true;
                await loadUserProfile(); // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ¶ˆãˆã¦ã„ã‚‹ãŸã‚ã€åå‰ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹

                feedbackEl.textContent = 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚åå‰ã‚’å†ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚';
                feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600', 'text-indigo-500');
                feedbackEl.classList.add('text-red-500');
            } catch (error) {
                console.error("Error resetting all data:", error);
                feedbackEl.textContent = 'ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                feedbackEl.classList.add('text-red-600');
            }
        }


        function initFirebase() {
            if (!FIREBASE_CONFIG.apiKey) {
                console.error("Firebase configuration is missing.");
                usernameDisplayEl.textContent = 'ã‚¨ãƒ©ãƒ¼';
                return;
            }
            const app = initializeApp(FIREBASE_CONFIG);
            window.db = getFirestore(app);
            window.auth = getAuth(app);

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Firebase initialized. User ID:", window.userId);
                    await loadUserProfile();
                } else {
                    usernameDisplayEl.textContent = 'èªè¨¼ä¸­...';
                    console.log("No user signed in. Attempting sign-in.");
                    try {
                        if (INITIAL_AUTH_TOKEN) {
                            await signInWithCustomToken(window.auth, INITIAL_AUTH_TOKEN);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        usernameDisplayEl.textContent = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
                    }
                }
            });
        }

        // --- Utility Functions (Globalized for access from HTML) ---

        window.formatTime = function(ms) {
            if (ms === Infinity || ms === null) return 'æœªç™»éŒ²';
            return (ms / 1000).toFixed(2) + 'ç§’';
        }

        window.showResetPrompt = function(mode) {
            resetModeInputEl.value = mode;
            resetPasswordAreaEl.classList.remove('hidden');
            passwordInputEl.value = ''; 
            passwordInputEl.focus();

            if (mode === 'all') {
                resetPromptTitleEl.textContent = 'ã€è­¦å‘Šã€‘åå‰ã¨è¨˜éŒ²ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            } else {
                resetPromptTitleEl.textContent = 'è¨˜éŒ²ï¼ˆã‚¿ã‚¤ãƒ ï¼‰ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            }

            feedbackEl.textContent = 'è¨˜éŒ²ãƒªã‚»ãƒƒãƒˆã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚';
            feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600', 'text-indigo-500');
            feedbackEl.classList.add('text-red-500');
        }

        window.hideResetPrompt = function() {
            resetPasswordAreaEl.classList.add('hidden');
            passwordInputEl.value = '';
            feedbackEl.textContent = 'ãƒªã‚»ãƒƒãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚';
            feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600', 'text-red-500');
            feedbackEl.classList.add('text-indigo-500');
        }

        window.confirmReset = function() {
            const enteredPassword = passwordInputEl.value;
            const mode = resetModeInputEl.value;

            if (enteredPassword === window.RESET_PASSWORD) {
                if (mode === 'all') {
                    resetNameAndRecord();
                } else {
                    resetRecordOnly();
                }
            } else {
                feedbackEl.textContent = 'âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
                feedbackEl.classList.remove('text-green-600', 'text-yellow-600', 'text-indigo-500');
                feedbackEl.classList.add('text-red-600');
                passwordInputEl.value = '';
                passwordInputEl.focus();
            }
        }


        // --- Game Logic ---

        window.startGame = function() {
            if (!window.userName) {
                usernameModalEl.classList.remove('hidden');
                return;
            }

            window.score = 0;
            window.currentQuestionIndex = 0;
            
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            feedbackEl.textContent = '';
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').disabled = false;
            document.getElementById('submit-button').disabled = false;
            document.getElementById('time-taken').textContent = 'ä»Šå›ã®å›ç­”æ™‚é–“: --';
            resetPasswordAreaEl.classList.add('hidden'); 

            // æº€ç‚¹æ¼”å‡ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('app').classList.remove('bg-yellow-50', 'shadow-2xl', 'shadow-yellow-400/50', 'transform', 'scale-105');
            
            // ç”»é¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('start-area').classList.add('hidden');
            document.getElementById('question-display').classList.remove('hidden');
            document.getElementById('answer-area').classList.remove('hidden');
            
            generateQuestions();
            updateStatusDisplay();
            showQuestion();
            document.getElementById('answer-input').focus(); 

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            window.startTime = Date.now();
        }

        function generateQuestions() {
            let allProblems = [];
            window.DANS.forEach(dan => {
                for (let kakeru = 1; kakeru <= 9; kakeru++) {
                    allProblems.push({ dan, kakeru, answer: dan * kakeru });
                }
            });

            for (let i = allProblems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allProblems[i], allProblems[j]] = [allProblems[j], allProblems[i]];
            }

            window.questions = allProblems.slice(0, window.MAX_QUESTIONS);
        }

        function showQuestion() {
            if (window.currentQuestionIndex < window.MAX_QUESTIONS) {
                const q = window.questions[window.currentQuestionIndex];
                
                document.getElementById('question-number').textContent = `ç¬¬ ${window.currentQuestionIndex + 1} å• / å…¨ ${window.MAX_QUESTIONS} å•`;
                document.getElementById('multiplier1').textContent = q.dan;
                document.getElementById('multiplier2').textContent = q.kakeru;

                document.getElementById('answer-input').value = '';
                feedbackEl.textContent = '';
            } else {
                endGame();
            }
        }

        window.checkAnswer = function() { 
            if (window.currentQuestionIndex >= window.MAX_QUESTIONS) return;

            const userAnswer = parseInt(document.getElementById('answer-input').value, 10);
            const currentQ = window.questions[window.currentQuestionIndex];
            const correctAnswer = currentQ.answer;

            if (isNaN(userAnswer)) {
                feedbackEl.textContent = 'ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                feedbackEl.classList.remove('text-green-600', 'text-red-600');
                feedbackEl.classList.add('text-yellow-600');
                return;
            }

            document.getElementById('answer-input').disabled = true;
            document.getElementById('submit-button').disabled = true;

            if (userAnswer === correctAnswer) {
                window.score++;
                feedbackEl.textContent = 'â­• æ­£è§£ï¼';
                feedbackEl.classList.remove('text-red-600', 'text-yellow-600');
                feedbackEl.classList.add('text-green-600');
            } else {
                feedbackEl.textContent = `âŒ ä¸æ­£è§£... æ­£ã—ã„ç­”ãˆã¯ ${correctAnswer} ã§ã—ãŸã€‚`;
                feedbackEl.classList.remove('text-green-600', 'text-yellow-600');
                feedbackEl.classList.add('text-red-600');
            }
            
            updateStatusDisplay();

            setTimeout(() => {
                window.currentQuestionIndex++;
                document.getElementById('answer-input').disabled = false;
                document.getElementById('submit-button').disabled = false;
                if (window.currentQuestionIndex < window.MAX_QUESTIONS) {
                    showQuestion();
                    document.getElementById('answer-input').focus();
                } else {
                    endGame();
                }
            }, window.NEXT_QUESTION_DELAY);
        }

        function updateStatusDisplay() {
            document.getElementById('current-score').textContent = `æ­£è§£æ•°: ${window.score} / ${window.currentQuestionIndex}`;
            const remaining = window.MAX_QUESTIONS - window.currentQuestionIndex;
            document.getElementById('current-question').textContent = `æ®‹ã‚Š: ${remaining < 0 ? 0 : remaining} å•`;
        }

        async function endGame() {
            document.getElementById('question-display').classList.add('hidden');
            document.getElementById('answer-area').classList.add('hidden');
            document.getElementById('start-area').classList.remove('hidden');
            
            if (window.currentQuestionIndex === window.MAX_QUESTIONS) {
                window.timeTaken = Date.now() - window.startTime;
                document.getElementById('time-taken').textContent = `ä»Šå›ã®å›ç­”æ™‚é–“: ${window.formatTime(window.timeTaken)}`;
            } else {
                document.getElementById('time-taken').textContent = 'ä»Šå›ã®å›ç­”æ™‚é–“: --';
            }
            
            let resultMessage = `ç·´ç¿’çµ‚äº†ï¼ ${window.MAX_QUESTIONS} å•ä¸­ ${window.score} å•æ­£è§£ã§ã—ãŸã€‚`;
            let resultColor = 'text-indigo-600';
            
            if (window.score === window.MAX_QUESTIONS) {
                resultMessage = `ğŸ‰ ãœã‚“ã‚‚ã‚“ã›ã„ã‹ã„ï¼ã™ã”ã„ï¼ãã¿ã¯ä¹ä¹ãƒã‚¹ã‚¿ãƒ¼ã ã­ï¼â­`;
                resultColor = 'text-green-600';

                let isNewRecord = false;
                if (window.timeTaken > 0 && window.timeTaken < window.bestTime) {
                    // æ–°è¨˜éŒ²é”æˆï¼Firestoreã«ä¿å­˜ã™ã‚‹
                    try {
                        const recordData = {
                            time: window.timeTaken,
                            timestamp: Date.now(),
                            userName: window.userName || 'åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼',
                            userId: window.userId
                        };
                        
                        // 1. å€‹äººè¨˜éŒ²ã‚’æ›´æ–° (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)
                        await setDoc(getPersonalBestTimeRef(window.userId), recordData);
                        
                        // 2. å…¬é–‹è¨˜éŒ²ã‚’æ›´æ–° (ãƒ‘ãƒ–ãƒªãƒƒã‚¯ - ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¦‹ã‚Œã‚‹ã‚ˆã†ã«)
                        await setDoc(getGlobalRecordRef(window.userId), recordData, { merge: true });

                        window.bestTime = window.timeTaken;
                        isNewRecord = true;
                    } catch (error) {
                        console.error("Failed to save new record to Firestore:", error);
                    }
                }
                
                await loadBestRecord(); // å€‹äººè¨˜éŒ²ã¨å…¨ä½“è¨˜éŒ²ã‚’å†èª­ã¿è¾¼ã¿ãƒ»è¡¨ç¤ºæ›´æ–°
                if (isNewRecord) {
                    personalBestEl.textContent += ' âœ¨ NEW RECORD!';
                    resultMessage += ' ğŸš€ æ–°è¨˜éŒ²é”æˆãŠã‚ã§ã¨ã†ï¼';
                }

                document.getElementById('app').classList.add('bg-yellow-50', 'shadow-2xl', 'shadow-yellow-400/50', 'transform', 'scale-105');
                
                setTimeout(() => {
                    document.getElementById('app').classList.remove('bg-yellow-50', 'shadow-2xl', 'shadow-yellow-400/50', 'transform', 'scale-105');
                }, 2000);
            } else if (window.score >= window.MAX_QUESTIONS * 0.8) {
                resultMessage += ' ç´ æ™´ã‚‰ã—ã„ï¼ã‚ã¨ä¸€æ¯ï¼';
            } else {
                resultMessage += ' æ¬¡ã¯æº€ç‚¹ã‚’ç›®æŒ‡ã—ã¦é ‘å¼µã‚ã†ï¼';
            }

            feedbackEl.textContent = resultMessage;
            feedbackEl.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600');
            feedbackEl.classList.add(resultColor);
            
            document.getElementById('start-button').textContent = 'ã‚‚ã†ä¸€åº¦ç·´ç¿’ã™ã‚‹';
            updateStatusDisplay();
        }


        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            updateStatusDisplay();
            feedbackEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­...';
            feedbackEl.classList.add('text-indigo-500');
        });
    </script>
</body>
</html>