<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ç·´ç¿’ã‚¢ãƒ—ãƒªï¼ˆ6, 7, 8ã®æ®µï¼‰</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#10b981',
                        background: '#f8fafc',
                        card: '#ffffff',
                    }
                }
            }
        }
    </script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            background-color: theme('colors.background');
        }
        .container {
            max-width: 500px;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefoxã§çŸ¢å°ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Chrome, Safariã§çŸ¢å°ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
            margin: 0;
        }
        /* æœ€é«˜è¨˜éŒ²æ›´æ–°æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(253, 224, 71, 0.7), 0 0 20px rgba(253, 224, 71, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(253, 224, 71, 1), 0 0 40px rgba(253, 224, 71, 0.8);
            }
        }
        .animate-pulse-strong {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="app" class="container bg-card shadow-2xl rounded-xl p-6 md:p-8 w-full">
        <h1 class="text-3xl font-bold text-center text-primary mb-6">
            ä¹ä¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° (6, 7, 8ã®æ®µ)
        </h1>
        <p class="text-center text-gray-600 mb-6">
            å…¨5å•ã€‚6ã®æ®µã€7ã®æ®µã€8ã®æ®µã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã¾ã™ã€‚
        </p>

        <!-- æœ€é«˜è¨˜éŒ²è¡¨ç¤ºã‚¨ãƒªã‚¢ (åˆæœŸçŠ¶æ…‹ã‹ã‚‰è¡¨ç¤º) -->
        <div class="text-center mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
            <p class="text-sm font-semibold text-gray-600">æœ€é«˜è¨˜éŒ² (æœ€çŸ­æ™‚é–“):</p>
            <p id="bestTimeText" class="text-2xl font-extrabold text-indigo-700">---</p>
        </div>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <button id="startButton" class="w-full bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01]">
            <svg class="w-5 h-5 inline mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26c0 .779.824 1.257 1.403.872l3.197-2.132a1 1 0 000-1.744z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹
        </button>

        <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="quizArea" class="hidden mt-8 space-y-4">
            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">å•é¡Œ</h2>
            <div id="questionsContainer" class="space-y-4">
                <!-- å•é¡Œã¯JavaScriptã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
            
            <!-- ç­”ãˆåˆã‚ã›ãƒœã‚¿ãƒ³ -->
            <button id="submitButton" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-150 ease-in-out shadow-lg">
                ç­”ãˆåˆã‚ã›
            </button>
        </div>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="resultArea" class="hidden mt-8 bg-indigo-50 p-6 rounded-lg border-2 border-indigo-200">
            <h2 class="text-2xl font-bold text-primary mb-4 text-center">çµæœ</h2>
            
            <!-- çµŒéæ™‚é–“è¡¨ç¤º -->
            <p class="text-lg font-medium text-gray-700 text-center">çµŒéæ™‚é–“:</p>
            <p id="timeText" class="text-4xl font-extrabold text-primary mb-4 text-center">0.00ç§’</p>

            <!-- æœ€é«˜è¨˜éŒ²æ›´æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="celebrationMessage" class="hidden text-center mb-6 p-4 bg-yellow-100 border-4 border-yellow-400 rounded-xl shadow-xl animate-pulse-strong">
                <p class="text-2xl font-black text-yellow-700">ğŸ†âœ¨ æœ€é«˜è¨˜éŒ²æ›´æ–°ï¼ãŠã‚ã§ã¨ã†ï¼ âœ¨ğŸ†</p>
            </div>

            <p id="scoreText" class="text-xl text-center font-extrabold mb-4"></p>
            
            <h3 class="text-lg font-semibold text-gray-800 border-t pt-4 mt-4 mb-3">è©³ç´°</h3>
            <div id="summaryContainer" class="space-y-3">
                <!-- å€‹åˆ¥ã®çµæœã¯JavaScriptã§æŒ¿å…¥ã•ã‚Œã‚‹ -->
            </div>
            
            <button id="resetButton" class="w-full bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg mt-6 transition duration-150 ease-in-out shadow-lg">
                ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹
            </button>
        </div>
    </div>

    <!-- Firebase SDKsã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const QUESTION_COUNT = 5; // å‡ºé¡Œæ•°
        let questions = [];      // å‡ºé¡Œãƒªã‚¹ãƒˆã‚’æ ¼ç´
        let currentAnswers = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£ç­”ã‚’æ ¼ç´
        let startTime = 0;       // è¨ˆæ¸¬é–‹å§‹æ™‚åˆ» (ms)

        // Firestore/Auth é–¢é€£
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let bestTimeMs = Infinity; // æœ€é«˜è¨˜éŒ²ï¼ˆãƒŸãƒªç§’, åˆæœŸå€¤ã¯ç„¡é™å¤§ï¼‰

        // DOMè¦ç´ ã®å–å¾—
        const startButton = document.getElementById('startButton');
        const quizArea = document.getElementById('quizArea');
        const resultArea = document.getElementById('resultArea');
        const questionsContainer = document.getElementById('questionsContainer');
        const submitButton = document.getElementById('submitButton');
        const scoreText = document.getElementById('scoreText');
        const summaryContainer = document.getElementById('summaryContainer');
        const resetButton = document.getElementById('resetButton');
        
        // ã‚¿ã‚¤ãƒ è¨ˆæ¸¬é–¢é€£ã®DOMè¦ç´ 
        const timeText = document.getElementById('timeText');
        const bestTimeText = document.getElementById('bestTimeText');
        const celebrationMessage = document.getElementById('celebrationMessage');


        // --- Firebase/Firestore é–¢é€£é–¢æ•° ---

        /**
         * Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼ã‚’è¡Œã†
         */
        async function initFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    // __initial_auth_tokenãŒãªã„å ´åˆã¯åŒ¿åèªè¨¼
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        loadHighScore(); // èªè¨¼å®Œäº†å¾Œã«æœ€é«˜è¨˜éŒ²ã‚’ãƒ­ãƒ¼ãƒ‰
                    } else {
                        // åŒ¿åèªè¨¼ã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        userId = null;
                        isAuthReady = true;
                        loadHighScore(); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication Error:", error);
                isAuthReady = true;
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ä¸€å¿œãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¢ãƒ—ãƒªã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
                loadHighScore();
            }
        }

        /**
         * Firestoreã‹ã‚‰æœ€é«˜è¨˜éŒ²ï¼ˆæœ€çŸ­æ™‚é–“ï¼‰ã‚’å–å¾—ã™ã‚‹
         */
        async function loadHighScore() {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or User ID not available for loading high score.");
                updateBestTimeDisplay();
                return;
            }

            // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹: /artifacts/{appId}/users/{userId}/highscores/multiplication_best_time
            const docPath = `/artifacts/${appId}/users/${userId}/highscores/multiplication_best_time`;
            const docRef = doc(db, docPath);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // data.bestTimeãŒæ•°å€¤å‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    if (data.bestTime && typeof data.bestTime === 'number') {
                        bestTimeMs = data.bestTime;
                        console.log("Loaded Best Time:", bestTimeMs);
                    }
                }
            } catch (e) {
                console.error("Error loading high score:", e);
            }
            updateBestTimeDisplay();
        }

        /**
         * Firestoreã«æœ€é«˜è¨˜éŒ²ï¼ˆæœ€çŸ­æ™‚é–“ï¼‰ã‚’ä¿å­˜ã™ã‚‹
         * @param {number} newBestTimeMs æ–°ã—ã„æœ€é«˜è¨˜éŒ²ï¼ˆãƒŸãƒªç§’ï¼‰
         */
        async function saveHighScore(newBestTimeMs) {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or User ID not available for saving high score.");
                return;
            }

            const docPath = `/artifacts/${appId}/users/${userId}/highscores/multiplication_best_time`;
            const docRef = doc(db, docPath);

            try {
                // setDocã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜/ä¸Šæ›¸ã
                await setDoc(docRef, { bestTime: newBestTimeMs, updatedAt: Date.now() });
                bestTimeMs = newBestTimeMs;
                console.log("High Score saved successfully:", newBestTimeMs);
                updateBestTimeDisplay();
            } catch (e) {
                console.error("Error saving high score:", e);
            }
        }

        /**
         * æœ€é«˜è¨˜éŒ²ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
         */
        function updateBestTimeDisplay() {
            if (bestTimeMs !== Infinity) {
                const seconds = (bestTimeMs / 1000).toFixed(2);
                bestTimeText.textContent = `${seconds}ç§’`;
            } else {
                bestTimeText.textContent = 'æœªç™»éŒ²';
            }
        }

        // --- ä¹ä¹ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜é–¢æ•°ã¨æ–°è¦é–¢æ•°ï¼‰ ---

        /**
         * 6, 7, 8ã®æ®µã®ä¹ä¹ã®å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã™ã‚‹
         */
        function generateQuestions() {
            const problems = [];
            const multipliers = [6, 7, 8];
            
            for (let i = 0; i < QUESTION_COUNT; i++) {
                const multiplierIndex = Math.floor(Math.random() * multipliers.length);
                const multiplier = multipliers[multiplierIndex];
                const multiplicand = Math.floor(Math.random() * 9) + 1;
                
                problems.push({
                    q: `${multiplier} Ã— ${multiplicand} =`,
                    answer: multiplier * multiplicand
                });
            }
            return problems;
        }

        /**
         * å•é¡Œã‚’ç”»é¢ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderQuestions() {
            questionsContainer.innerHTML = '';
            currentAnswers = Array(questions.length).fill(null);

            questions.forEach((q, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'flex items-center space-x-4 bg-gray-50 p-4 rounded-lg shadow-sm';
                questionElement.innerHTML = `
                    <p class="text-lg font-medium w-1/3 text-gray-700">${index + 1}. ${q.q}</p>
                    <input type="number" id="answer-${index}" data-index="${index}" placeholder="ç­”ãˆ"
                           class="answer-input w-2/3 p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary text-lg text-center font-mono">
                `;
                questionsContainer.appendChild(questionElement);
            });
            
            // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('.answer-input').forEach(input => {
                input.addEventListener('input', handleAnswerInput);
            });
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£ç­”ã‚’å…¥åŠ›æ™‚ã«ä¿å­˜ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©
         */
        function handleAnswerInput(event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            // æ•°å€¤ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã€‚ç©ºæ–‡å­—ã®å ´åˆã¯nullã‚’æ ¼ç´
            currentAnswers[index] = input.value === '' ? null : parseInt(input.value);
        }

        /**
         * ç­”ãˆåˆã‚ã›å‡¦ç†
         */
        async function checkAnswers() {
            const endTime = Date.now();
            const elapsedTime = endTime - startTime; // çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
            let correctCount = 0;
            summaryContainer.innerHTML = '';
            celebrationMessage.classList.add('hidden'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ

            // 1. æ­£èª¤åˆ¤å®šã¨çµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
            questions.forEach((q, index) => {
                const userAnswer = currentAnswers[index];
                const isCorrect = userAnswer === q.answer;
                
                if (isCorrect) {
                    correctCount++;
                }

                // çµæœã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
                const summaryItem = document.createElement('div');
                summaryItem.className = `p-3 rounded-lg flex justify-between items-center ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
                
                const icon = isCorrect 
                    ? `<svg class="w-6 h-6 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                    : `<svg class="w-6 h-6 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

                const detailText = isCorrect
                    ? `æ­£è§£ï¼`
                    : `é–“é•ã„... æ­£è§£ã¯ ${q.answer}`;

                const resultClass = isCorrect ? 'text-green-800' : 'text-red-800';

                summaryItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="mr-3">${icon}</div>
                        <p class="font-semibold text-gray-800">${index + 1}. ${q.q}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">ã‚ãªãŸã®ç­”ãˆ: <span class="font-mono ${userAnswer === null ? 'text-gray-400' : 'font-bold'}">${userAnswer !== null ? userAnswer : 'æœªå…¥åŠ›'}</span></p>
                        <p class="font-bold ${resultClass}">${detailText}</p>
                    </div>
                `;
                summaryContainer.appendChild(summaryItem);
            });

            // 2. ã‚¹ã‚³ã‚¢ã¨ã‚¿ã‚¤ãƒ ã®è¡¨ç¤º
            scoreText.textContent = `${QUESTION_COUNT}å•ä¸­ã€${correctCount}å•æ­£è§£ï¼`;
            scoreText.className = `text-xl text-center font-extrabold mb-4 ${correctCount === QUESTION_COUNT ? 'text-secondary' : 'text-primary'}`;
            
            // ã‚¿ã‚¤ãƒ è¡¨ç¤º
            const elapsedSeconds = (elapsedTime / 1000).toFixed(2);
            timeText.textContent = `${elapsedSeconds}ç§’`;


            // 3. æœ€é«˜è¨˜éŒ²ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯ (å…¨å•æ­£è§£ã‹ã¤ã€ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ãŒæœ€é«˜è¨˜éŒ²ã‚ˆã‚Šã‚‚é€Ÿã„å ´åˆ)
            if (correctCount === QUESTION_COUNT && elapsedTime < bestTimeMs) {
                // æœ€é«˜è¨˜éŒ²æ›´æ–°ï¼
                celebrationMessage.classList.remove('hidden');
                await saveHighScore(elapsedTime); // Firestoreã«ä¿å­˜
            }

            // 4. ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            quizArea.classList.add('hidden');
            resultArea.classList.remove('hidden');
        }

        /**
         * ã‚¢ãƒ—ãƒªã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
         */
        function resetApp() {
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.remove('hidden');
            quizArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            questionsContainer.innerHTML = '';
            summaryContainer.innerHTML = '';
            celebrationMessage.classList.add('hidden');
            timeText.textContent = '0.00ç§’'; // ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ

            updateBestTimeDisplay(); // æœ€é«˜è¨˜éŒ²ã‚’å†è¡¨ç¤º
        }


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        startButton.addEventListener('click', () => {
            questions = generateQuestions(); // å•é¡Œã‚’ç”Ÿæˆ
            renderQuestions();                // å•é¡Œã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            startTime = Date.now();           // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.add('hidden');
            quizArea.classList.remove('hidden');
            resultArea.classList.add('hidden');
        });

        submitButton.addEventListener('click', checkAnswers);

        resetButton.addEventListener('click', resetApp);
        
        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸåŒ–
        initFirebaseAndAuth(); // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼ã‚’é–‹å§‹
        resetApp(); // UIã‚’åˆæœŸçŠ¶æ…‹ã«ã™ã‚‹

    </script>
</body>
</html>